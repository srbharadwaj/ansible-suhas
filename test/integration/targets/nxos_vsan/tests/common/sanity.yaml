---
- debug: msg="START nxos_vsan sanity test with connection={{ ansible_connection }} "
- debug: msg="Using provider={{ connection.transport }}"
  when: ansible_connection == "local"
- debug: msg="Using vsans {{ vsan1 }}, {{ vsan2 }} for running this sanity test"
  

- block:
  - name: Setup - Remove vsan if configured
    nxos_vsan: &remove
      vsan:
        - { id: "{{ vsan1 | int }}", remove: True}
        - { id: "{{ vsan2 | int }}", remove: True}
    ignore_errors: yes

  - name: Configure vsan
    nxos_vsan: &config
      vsan:
           - id: "{{ vsan1 | int }}"
             name: vsan-SAN-A
             suspend: True
             interface:
                - "{{intA1}}"
             remove: False
           - id: "{{ vsan2 | int }}"
             name: vsan-SAN-B
             #suspend: True
             interface:
                - "{{intB1}}"
             remove: False
    register: result

  - assert: &true
      that:
        - "result.changed == true"

  - name: Idempotence Check
    nxos_vsan: *config
    register: result

  - assert: &false
      that:
        - "result.changed == false"

  # - name: Configure ntp with some defaults
  #   nxos_ntp: &config1
  #     peer: 1.2.3.4
  #     key_id: default
  #     prefer: enabled
  #     vrf_name: default
  #     source_addr: default
  #     provider: "{{ connection }}"
  #     state: present
  #   register: result

  # - assert: *true

  # - name: Idempotence Check
  #   nxos_ntp: *config1
  #   register: result

  # - assert: *false

  # - name: Remove ntp config
  #   nxos_ntp: *remove
  #   register: result

  # - assert: *true

  # - name: Remove Idempotence Check
  #   nxos_ntp: *remove
  #   register: result

  # - assert: *false

  # - name: Configure ntp again
  #   nxos_ntp: &config2
  #     source_int: Ethernet1/3
  #     peer: 1.2.3.4
  #     prefer: enabled
  #     provider: "{{ connection }}"
  #     state: present
  #   register: result

  # - assert: *true

  # - name: Idempotence Check
  #   nxos_ntp: *config2
  #   register: result

  # - assert: *false

  # - name: Remove source interface
  #   nxos_ntp: &config3
  #     source_int: default
  #     provider: "{{ connection }}"
  #     state: present
  #   register: result

  # - assert: *true

  # - name: Idempotence Check
  #   nxos_ntp: *config3
  #   register: result

  # - assert: *false

  # - name: Remove ntp
  #   nxos_ntp: *remove
  #   register: result

  # - assert: *true

  # - name: Remove Idempotence Check
  #   nxos_ntp: *remove
  #   register: result

  # - assert: *false

  always:
  - name: Remove vsan config
    nxos_vsan: *remove
